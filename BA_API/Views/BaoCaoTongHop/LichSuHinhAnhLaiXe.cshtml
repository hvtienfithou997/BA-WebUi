
@{
    ViewData["Title"] = "Lịch sử hình ảnh lái xe";
}

<style>
    #report2 {
        font-size: 14px;
    }

        #report2 thead tr th {
            padding: 0.5rem;
        }

    #embedIframe {
        padding: 0 15px 0 0;
    }


    #report2 {
        display: block;
        height: 600px;
        overflow: auto;
    }

        #report2 thead, #report2 tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        #report2 thead {
            *width: calc( 100% - 1em ) /* scrollbar is average 1em/16px width, remove it from thead width */
        }

    #report2 {
        *width: 400px;
    }

    .textDisplay {
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        cursor: pointer
    }

    .image {
        position: absolute;
        top: 0px;
        right: 30px;
        width: 40%;
        height: 40%;
        background-position: right;
        background-repeat: no-repeat;
        background-size: contain;
    }
</style>

<div class="col-xl-12 col-lg-12">
    <div class="card mb-4">
        <div class="card-header py-3 flex-row align-items-center justify-content-between">

            <div class="row">
                <div class="col-xl-3 col-lg-3 ">
                    <label for="start">Từ ngày</label>
                    <input type="text" class="form-control" autocomplete="off" id="start" name="start" placeholder="Từ ngày">

                </div>
                <div class="col-xl-3 col-lg-3 ">
                    <label for="end">Đến ngày</label>
                    <input type="text" class="form-control" autocomplete="off" id="end" name="end" placeholder="Đến ngày">
                </div>
                <div class="col-xl-3 col-lg-3 ">
                    <label for="licensePlate">Biển số xe</label>
                    <input type="text" class="form-control" id="licensePlate" placeholder="Biển số xe">
                </div>
                <div class="col-xl-3 col-lg-3" style="position: relative">
                    <button type="submit" name="btnResult" class="btn btn-info" style="margin: auto; position: absolute;bottom: 0">Tìm kiếm</button>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-xl-4 col-lg-12 ">
                <div class="table-responsive p-3">
                    <table id="report2" class="table table-bordered text-center" style="color: black;text-align: left">
                        <thead>
                            <tr>
                                <th>Địa chỉ</th>
                                <!--<th>Tốc độ</th>-->
                                <th>Thời gian</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="col-xl-8 col-lg-12" style="position: relative">
                <div id="image" class="image">

                </div>
                <div id="embedIframe">

                </div>
            </div>
        </div>
        <nav aria-label="Page navigation">
            <ul class="pagination"></ul>
        </nav>
    </div>
</div>

<!-- Hiển thị dữ liệu-->
<div class="col-xl-12 col-lg-12 d-none">
    <div class="card mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">Lịch sử hình ảnh lái xe</h6>
        </div>
        <div class="table-responsive p-3">
            <table id="report" class="table table-bordered text-center" style="color: black;text-align: left">
                <thead>
                    <tr>
                        <th>Biển số xe</th>
                        <th>Tên lái xe</th>
                        <th>Giấy phép lái xe</th>
                        <th>Thời gian truyền</th>
                        <th>Kinh độ</th>
                        <th>Vĩ độ</th>
                        <th>Tốc độ</th>
                        <th>Hình ảnh vi phạm</th>
                        <th>Địa chỉ</th>
                        <th>Trạng thái</th>
                        <th>Loại vi phạm</th>
                        <th>Kênh</th>
                    </tr>
                </thead>
                <tbody></tbody>
                <tfoot><tr></tr></tfoot>
            </table>
        </div>
        <nav aria-label="Page navigation">
            <ul class="pagination"></ul>
        </nav>
    </div>
</div>

<script>
    //datePicker();
    $(function () {
        $('.map-btn').click(function (event) {
            event.preventDefault();
            var lat = 10.829619407653809;
            var lng = 106.76204681396484;
            showMap(lat, lng);
        });

        $('#report2 tbody').on('click', 'tr', function () {
            $("#embedIframe").append(DIV_LOADING);
            var lat = $(this).attr("data-latitude");
            var lng = $(this).attr("data-longitude");
            var urlImg = $(this).attr("data-img");
            showMap(lat, lng, urlImg);
            $("#div_loader").remove();
        });

    });

    function showMap(lat, lng, urlImg) {
        let iframe = `<iframe width="100%" height="600px" src="https://maps.google.com/maps?q=${lat},${lng}&hl=es;z=14&amp;output=embed&z=14"></iframe>`;
        $("#embedIframe").html(iframe);
        $("#image").css("background-image", `url('${urlImg}')`);
    }
    //
</script>

<script>


    var plate = '@ViewBag.plate';
    var start = @ViewBag.start;
    var end = @ViewBag.end;
    var index = '@ViewBag.index';
    $(document).ready(function () {



        SetDefaultDateTime();


        if (start > 0) {
            let d = new Date(start).toLocaleString("en-GB", { hour12: false });
            jQuery('#start').datetimepicker({
                value: d,
                format: 'd/m/Y H:i',
                lang: 'vi',
                onShow: function (ct) {
                    this.setOptions({
                        maxDate: jQuery('#end').val() ? jQuery('#end').val() : false
                    });
                },
                onHide: function() {
                    this.setOptions({

                    });
                }
            });
        }

        if (end > 0) {
            let d = new Date(start + interval - 1).toLocaleString("en-GB", { hour12: false });
            jQuery('#end').datetimepicker({
                value: d,
                format: 'd/m/Y H:i',
                lang: 'vi',
                onShow: function (ct) {
                    this.setOptions({
                        minDate: jQuery('#start').val() ? jQuery('#start').val() : false
                    });
                }
            });
        }
        

        $("#licensePlate").val(plate);

        if (plate !== "") 
            showResult2(index);
        

    });

    $("[name='btnResult']").click(function (e) {
        e.preventDefault();
        showResult2();
    });


    function showResult2(index) {
        $("#div_loader").remove();
        var licensePlate = $("#licensePlate").val();
        var start = $("#start").val();
        var end = $("#end").val();
        start = start !== "" ? strToDate(start) : 0;
        end = end !== "" ? strToDate(end) : 0;

        //$("#report tbody tr").remove();
        window.history.pushState(window.location.href, "Lịch sử hình ảnh lái xe", `?plate=${licensePlate}&start=${start}&end=${end}`);
        callApi(`${WAY_URL}waypoint/${licensePlate}/${start}/${end}`, null, "GET", function (item) {
            if (item.length > 0) {
                $.notify("Tải dữ liệu thành công", "success");
                let res = "";
                let count = 1;
                item.forEach(function (pro) {
                    res += `<tr data-latitude='${pro.latitude}' data-longitude='${pro.longitude}' data-img='${pro.image_url}'>`;
                    if (pro.address !== "" || pro.address !== null) res += `<td class='textDisplay' title='${pro.address}'><code>${pro.address}</code></td>`;else res += `<td></td>`;

                    res += `<td>${pro.stime}</td>`;
                    res += "</tr>";
                    count++;
                });
                $("#report2 tbody").html(res);

            } else {
                $.notify(`Không tìm thấy kết quả nào`, "error");
                $("#report2 tbody tr").remove();
                $("#embedIframe iframe").remove();
            }
            $("#div_loader").remove();
        });
    }
</script>

